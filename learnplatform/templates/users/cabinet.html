{% extends 'base.html' %}

{% block title %}–ö–∞–±—ñ–Ω–µ—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞{% endblock %}

{% block content %}
<h1 class="mb-4">–ü—Ä–∏–≤—ñ—Ç, {{ user.username }}!</h1>

{% if user.is_student and stats %}
    <div class="alert alert-info">
        üìä –ü—Ä–æ–π–¥–µ–Ω–æ —Ç–µ—Å—Ç—ñ–≤: <strong>{{ stats.completed }}</strong> –∑ <strong>{{ stats.total }}</strong><br>
        ‚úÖ –°–µ—Ä–µ–¥–Ω—ñ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <strong>{{ stats.success }}%</strong>
    </div>
{% endif %}


{% if user.is_teacher %}
    <p>–í–∏ –≤–∏–∫–ª–∞–¥–∞—á. –ù–∏–∂—á–µ —Å–ø–∏—Å–æ–∫ –≤–∞—à–∏—Ö –∫—É—Ä—Å—ñ–≤:</p>
{% else %}
    <p>–í–∏ —Å—Ç—É–¥–µ–Ω—Ç. –í–∏ –∑–∞–ø–∏—Å–∞–Ω—ñ –Ω–∞ —Ç–∞–∫—ñ –∫—É—Ä—Å–∏:</p>
{% endif %}

{% if user.is_authenticated and user.is_teacher %}
    <a class="btn btn-sm btn-outline-primary ms-3" href="{% url 'courses:create' %}">
       ‚ûï –î–æ–¥–∞—Ç–∏ –∫—É—Ä—Å
    </a>
{% endif %}

{% if courses %}
    <ul class="list-group mt-3">
        {% for course in courses %}
            <li class="list-group-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong><a href="{% url 'courses:detail' course.id %}">{{ course.title }}</a></strong>
                        {{ course.description|linebreaks }}
                    </div>
                    {% if user.is_teacher %}
                        <a href="{% url 'courses:add_lesson' course.id %}" class="btn btn-sm btn-outline-primary ms-3">
                            ‚ûï –î–æ–¥–∞—Ç–∏ —É—Ä–æ–∫
                        </a>
                    {% endif %}
                </div>
            </li>
        {% endfor %}
    </ul>
{% else %}
    <p class="text-muted">–ù–µ–º–∞—î –∫—É—Ä—Å—ñ–≤.</p>
{% endif %}
{% if user.is_student %}
    <a href="{% url 'courses:available' %}" class="btn btn-outline-success mt-3">
        üìö –î–æ—Å—Ç—É–ø–Ω—ñ –∫—É—Ä—Å–∏
    </a>
{% endif %}

{% if user.is_student and quiz_attempts %}
    <hr class="my-4">
    <h4>
        üìù –Ü—Å—Ç–æ—Ä—ñ—è —Ç–µ—Å—Ç—ñ–≤
        <a href="{% url 'users:student_report_pdf' %}" class="btn btn-outline-danger">
            ‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–≤—ñ—Ç PDF
        </a>
    </h4>
    <table class="table table-sm table-striped mt-3">
        <thead>
            <tr>
                <th>–ö—É—Ä—Å</th>
                <th>–£—Ä–æ–∫</th>
                <th>–¢–µ—Å—Ç</th>
                <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                <th>–î–∞—Ç–∞</th>
            </tr>
        </thead>
        <tbody>
            {% for attempt in quiz_attempts %}
                <tr>
                    <td>
                        <a href="{% url 'courses:detail' attempt.quiz.lesson.course.id %}">
                            {{ attempt.quiz.lesson.course.title }}
                        </a>
                    </td>
                    <td>
                        <a href="{% url 'courses:lesson_detail' attempt.quiz.lesson.course.id attempt.quiz.lesson.id %}">
                            {{ attempt.quiz.lesson.title }}
                        </a>
                    </td>
                    <td>{{ attempt.quiz.title }}</td>
                    <td>{{ attempt.score }}%</td>
                    <td>{{ attempt.completed_at|date:"Y-m-d H:i" }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% elif user.is_student %}
    <hr class="my-4">
    <h4>üìù –Ü—Å—Ç–æ—Ä—ñ—è —Ç–µ—Å—Ç—ñ–≤</h4>
    <p class="text-muted">–í–∏ —â–µ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ –∂–æ–¥–Ω–æ–≥–æ —Ç–µ—Å—Ç—É.</p>
{% endif %}

{% if recommendations %}
<hr class="my-4">
<h4>üß† –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–Ω—è</h4>
<ul class="list-group">
    {% for lesson, count in recommendations %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <a href="{% url 'courses:lesson_detail' lesson.course.id lesson.id %}">
                {{ lesson.title }}
            </a>
            <span class="badge bg-warning text-dark">‚úñ {{ count }} –ø–æ–º–∏–ª–æ–∫</span>
        </li>
    {% endfor %}
</ul>
{% endif %}

{% if user.is_student and detailed_recommendations %}
<hr class="my-5">
<h4>üß† –î–µ—Ç–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –ø–æ —Ç–µ–º–∞—Ö</h4>
<p class="text-muted">–ù–∞ –æ—Å–Ω–æ–≤—ñ –≤–∞—à–∏—Ö –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π —É —Ç–µ—Å—Ç–∞—Ö:</p>

<div class="accordion" id="recommendationsAccordion">
    {% for key, questions in detailed_recommendations.items %}
        {% with lesson_id=key.0 lesson_title=key.1 course_id=key.2 course_title=key.3 %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading-{{ lesson_id }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapse-{{ lesson_id }}" aria-expanded="false"
                            aria-controls="collapse-{{ lesson_id }}">
                        {{ course_title }} ‚Äî {{ lesson_title }}
                    </button>
                </h2>
                <div id="collapse-{{ lesson_id }}" class="accordion-collapse collapse"
                     aria-labelledby="heading-{{ lesson_id }}" data-bs-parent="#recommendationsAccordion">
                    <div class="accordion-body">
                        <p class="mb-1"><strong>–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É –Ω–∞ —Ç–∞–∫—ñ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è:</strong></p>
                        <ul class="mb-3">
                            {% for q in questions %}
                                <li>{{ q }}</li>
                            {% endfor %}
                        </ul>
                        <a href="{% url 'courses:lesson_detail' course_id lesson_id %}" class="btn btn-sm btn-outline-primary">
                            üìò –ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ —Ç–µ–º—É
                        </a>
                    </div>
                </div>
            </div>
        {% endwith %}
    {% endfor %}
{% endif %}

{% endblock %}

